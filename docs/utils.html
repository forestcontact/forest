<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>utils API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>utils</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import logging
import os
from asyncio.subprocess import PIPE, create_subprocess_exec
from contextlib import asynccontextmanager
from typing import Any, AsyncIterator, Optional, cast
import phonenumbers as pn
from phonenumbers import NumberParseException


def FuckAiohttp(record: logging.LogRecord) -&gt; bool:
    str_msg = str(getattr(record, &#34;msg&#34;, &#34;&#34;))
    if &#34;was destroyed but it is pending&#34; in str_msg:
        return False
    if str_msg.startswith(&#34;task:&#34;) and str_msg.endswith(&#34;&gt;&#34;):
        return False
    return True


TRACE = logging.DEBUG - 10
logging.addLevelName(TRACE, &#34;TRACE&#34;)

logger_class = logging.getLoggerClass()


class TraceLogger(logger_class):  # type: ignore
    def trace(self, msg: str, *args: Any, **kwargs: Any) -&gt; None:
        self.log(TRACE, msg, *args, **kwargs)


logging.setLoggerClass(TraceLogger)

logging.basicConfig(
    level=os.getenv(&#34;LOGLEVEL&#34;, &#34;DEBUG&#34;),
    format=&#34;{levelname} {module}:{lineno}: {message}&#34;,
    style=&#34;{&#34;,
)
logger = logging.getLogger()
logging.getLogger().handlers[0].addFilter(FuckAiohttp)

# edge cases:
# accessing an unset secret loads other variables and potentially overwrites existing ones
# &#34;false&#34; being truthy is annoying


def load_secrets(env: Optional[str] = None, overwrite: bool = False) -&gt; None:
    if not env:
        env = os.environ.get(&#34;ENV&#34;, &#34;dev&#34;)
    try:
        logging.info(&#34;loading secrets from %s_secrets&#34;, env)
        secrets = [line.strip().split(&#34;=&#34;, 1) for line in open(f&#34;{env}_secrets&#34;)]
        can_be_a_dict = cast(list[tuple[str, str]], secrets)
        if overwrite:
            new_env = dict(can_be_a_dict)
        else:
            new_env = (
                dict(can_be_a_dict) | os.environ
            )  # mask loaded secrets with existing env
        os.environ.update(new_env)
    except FileNotFoundError:
        pass


def get_secret(key: str, env: Optional[str] = None) -&gt; str:
    try:
        return os.environ[key]
    except KeyError:
        load_secrets(env)
        return os.environ.get(key) or &#34;&#34;  # fixme


HOSTNAME = open(&#34;/etc/hostname&#34;).read().strip()  #  FLY_ALLOC_ID
APP_NAME = os.getenv(&#34;FLY_APP_NAME&#34;)
URL = f&#34;https://{APP_NAME}.fly.dev&#34;
LOCAL = APP_NAME is None
ROOT_DIR = (
    &#34;.&#34; if get_secret(&#34;NO_DOWNLOAD&#34;) else &#34;/tmp/local-signal&#34; if LOCAL else &#34;/app&#34;
)

if get_secret(&#34;LOGFILES&#34;):
    tracelog = logging.FileHandler(&#34;trace.log&#34;)
    tracelog.setLevel(TRACE)
    logger.addHandler(tracelog)
    handler = logging.FileHandler(&#34;debug.log&#34;)
    handler.setLevel(&#34;DEBUG&#34;)
    logger.addHandler(handler)


def signal_format(raw_number: str) -&gt; Optional[str]:
    try:
        return pn.format_number(pn.parse(raw_number, &#34;US&#34;), pn.PhoneNumberFormat.E164)
    except NumberParseException:
        return None


@asynccontextmanager
async def get_url(port: int = 8080) -&gt; AsyncIterator[str]:
    if not APP_NAME:
        try:
            logging.info(&#34;starting tunnel&#34;)
            tunnel = await create_subprocess_exec(
                *(f&#34;lt -p {port}&#34;.split()),
                stdout=PIPE,
            )
            assert tunnel.stdout
            line = await tunnel.stdout.readline()
            url = line.decode().lstrip(&#34;your url is: &#34;).strip()
            yield url + &#34;/inbound&#34;
        finally:
            logging.info(&#34;terminaitng tunnel&#34;)
            tunnel.terminate()
    else:
        yield APP_NAME + &#34;.fly.io&#34;</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="utils.FuckAiohttp"><code class="name flex">
<span>def <span class="ident">FuckAiohttp</span></span>(<span>record: logging.LogRecord) ‑> bool</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def FuckAiohttp(record: logging.LogRecord) -&gt; bool:
    str_msg = str(getattr(record, &#34;msg&#34;, &#34;&#34;))
    if &#34;was destroyed but it is pending&#34; in str_msg:
        return False
    if str_msg.startswith(&#34;task:&#34;) and str_msg.endswith(&#34;&gt;&#34;):
        return False
    return True</code></pre>
</details>
</dd>
<dt id="utils.get_secret"><code class="name flex">
<span>def <span class="ident">get_secret</span></span>(<span>key: str, env: Optional[str] = None) ‑> str</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_secret(key: str, env: Optional[str] = None) -&gt; str:
    try:
        return os.environ[key]
    except KeyError:
        load_secrets(env)
        return os.environ.get(key) or &#34;&#34;  # fixme</code></pre>
</details>
</dd>
<dt id="utils.get_url"><code class="name flex">
<span>async def <span class="ident">get_url</span></span>(<span>port: int = 8080) ‑> AsyncIterator[str]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@asynccontextmanager
async def get_url(port: int = 8080) -&gt; AsyncIterator[str]:
    if not APP_NAME:
        try:
            logging.info(&#34;starting tunnel&#34;)
            tunnel = await create_subprocess_exec(
                *(f&#34;lt -p {port}&#34;.split()),
                stdout=PIPE,
            )
            assert tunnel.stdout
            line = await tunnel.stdout.readline()
            url = line.decode().lstrip(&#34;your url is: &#34;).strip()
            yield url + &#34;/inbound&#34;
        finally:
            logging.info(&#34;terminaitng tunnel&#34;)
            tunnel.terminate()
    else:
        yield APP_NAME + &#34;.fly.io&#34;</code></pre>
</details>
</dd>
<dt id="utils.load_secrets"><code class="name flex">
<span>def <span class="ident">load_secrets</span></span>(<span>env: Optional[str] = None, overwrite: bool = False) ‑> None</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_secrets(env: Optional[str] = None, overwrite: bool = False) -&gt; None:
    if not env:
        env = os.environ.get(&#34;ENV&#34;, &#34;dev&#34;)
    try:
        logging.info(&#34;loading secrets from %s_secrets&#34;, env)
        secrets = [line.strip().split(&#34;=&#34;, 1) for line in open(f&#34;{env}_secrets&#34;)]
        can_be_a_dict = cast(list[tuple[str, str]], secrets)
        if overwrite:
            new_env = dict(can_be_a_dict)
        else:
            new_env = (
                dict(can_be_a_dict) | os.environ
            )  # mask loaded secrets with existing env
        os.environ.update(new_env)
    except FileNotFoundError:
        pass</code></pre>
</details>
</dd>
<dt id="utils.signal_format"><code class="name flex">
<span>def <span class="ident">signal_format</span></span>(<span>raw_number: str) ‑> Optional[str]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def signal_format(raw_number: str) -&gt; Optional[str]:
    try:
        return pn.format_number(pn.parse(raw_number, &#34;US&#34;), pn.PhoneNumberFormat.E164)
    except NumberParseException:
        return None</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="utils.TraceLogger"><code class="flex name class">
<span>class <span class="ident">TraceLogger</span></span>
<span>(</span><span>name, level=0)</span>
</code></dt>
<dd>
<div class="desc"><p>Instances of the Logger class represent a single logging channel. A
"logging channel" indicates an area of an application. Exactly how an
"area" is defined is up to the application developer. Since an
application can have any number of areas, logging channels are identified
by a unique string. Application areas can be nested (e.g. an area
of "input processing" might include sub-areas "read CSV files", "read
XLS files" and "read Gnumeric files"). To cater for this natural nesting,
channel names are organized into a namespace hierarchy where levels are
separated by periods, much like the Java or Python package namespace. So
in the instance given above, channel names might be "input" for the upper
level, and "input.csv", "input.xls" and "input.gnu" for the sub-levels.
There is no arbitrary limit to the depth of nesting.</p>
<p>Initialize the logger with a name and an optional level.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class TraceLogger(logger_class):  # type: ignore
    def trace(self, msg: str, *args: Any, **kwargs: Any) -&gt; None:
        self.log(TRACE, msg, *args, **kwargs)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>forest.utils.TraceLogger</li>
<li>logging.Logger</li>
<li>logging.Filterer</li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="utils.TraceLogger.trace"><code class="name flex">
<span>def <span class="ident">trace</span></span>(<span>self, msg: str, *args: Any, **kwargs: Any) ‑> None</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def trace(self, msg: str, *args: Any, **kwargs: Any) -&gt; None:
    self.log(TRACE, msg, *args, **kwargs)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="utils.FuckAiohttp" href="#utils.FuckAiohttp">FuckAiohttp</a></code></li>
<li><code><a title="utils.get_secret" href="#utils.get_secret">get_secret</a></code></li>
<li><code><a title="utils.get_url" href="#utils.get_url">get_url</a></code></li>
<li><code><a title="utils.load_secrets" href="#utils.load_secrets">load_secrets</a></code></li>
<li><code><a title="utils.signal_format" href="#utils.signal_format">signal_format</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="utils.TraceLogger" href="#utils.TraceLogger">TraceLogger</a></code></h4>
<ul class="">
<li><code><a title="utils.TraceLogger.trace" href="#utils.TraceLogger.trace">trace</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>